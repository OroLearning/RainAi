import React, { useState, useEffect } from 'react';
import Navbar from './components/Navbar';
import VisualMockup from './components/VisualMockup';
import WhatWeDo from './components/WhatWeDo';
import ProcessSteps from './components/ProcessSteps';
import Pricing from './components/Pricing';
import DashboardView from './components/DashboardView';
import AuthModal from './components/AuthModal';
import { LaunchSequence } from './types';

const App: React.FC = () => {
  const [productInfo, setProductInfo] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [view, setView] = useState<'landing' | 'dashboard'>('landing');
  const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
  const [openSettingsOnDash, setOpenSettingsOnDash] = useState(false);
  const [user, setUser] = useState<{ email: string; name: string } | null>(() => {
    const saved = localStorage.getItem('rain_logged_user');
    return saved ? JSON.parse(saved) : null;
  });

  const [darkMode, setDarkMode] = useState(() => {
    return localStorage.getItem('rain_theme') === 'dark' || document.documentElement.classList.contains('dark');
  });

  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
      document.body.classList.add('dark');
      localStorage.setItem('rain_theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      document.body.classList.remove('dark');
      localStorage.setItem('rain_theme', 'light');
    }
  }, [darkMode]);

  useEffect(() => {
    if (view === 'landing') {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((e) => e.isIntersecting && e.target.classList.add('active'));
      }, { threshold: 0.1 });
      document.querySelectorAll('.reveal').forEach((el) => observer.observe(el));
      return () => observer.disconnect();
    }
  }, [view]);

  const handleLaunchDashboard = () => {
    setOpenSettingsOnDash(false);
    if (!user) {
      setIsAuthModalOpen(true);
    } else {
      setView('dashboard');
    }
  };

  const handleSettingsClick = () => {
    setOpenSettingsOnDash(true);
    if (!user) {
      setIsAuthModalOpen(true);
    } else {
      setView('dashboard');
    }
  };

  const handleAuthSuccess = (userData: { email: string; name: string }) => {
    setUser(userData);
    localStorage.setItem('rain_logged_user', JSON.stringify(userData));
    setIsAuthModalOpen(false);
    setView('dashboard');
  };

  const handleLogout = () => {
    setUser(null);
    localStorage.removeItem('rain_logged_user');
    setOpenSettingsOnDash(false);
    setView('landing');
  };

  const handleUpdateUser = (newName: string) => {
    if (user) {
      const updatedUser = { ...user, name: newName };
      setUser(updatedUser);
      localStorage.setItem('rain_logged_user', JSON.stringify(updatedUser));
      
      // Also update in the global users storage
      const users = JSON.parse(localStorage.getItem('rain_users') || '{}');
      const normalizedEmail = user.email.toLowerCase();
      if (users[normalizedEmail]) {
        users[normalizedEmail].name = newName;
        localStorage.setItem('rain_users', JSON.stringify(users));
      }
    }
  };

  if (view === 'dashboard' && user) return (
    <DashboardView 
      onBack={() => setView('landing')} 
      userName={user.name} 
      userEmail={user.email}
      onLogout={handleLogout}
      onUpdateUser={handleUpdateUser}
      darkMode={darkMode}
      setDarkMode={setDarkMode}
      initialPrompt={productInfo}
      openSettingsInitially={openSettingsOnDash}
    />
  );

  return (
    <div className="min-h-screen hero-bg dark:bg-darkBg dark:text-slate-100 transition-colors duration-300">
      <Navbar onActionClick={handleLaunchDashboard} onSettingsClick={handleSettingsClick} />
      
      <AuthModal 
        isOpen={isAuthModalOpen} 
        onClose={() => setIsAuthModalOpen(false)} 
        onSuccess={handleAuthSuccess} 
      />

      <main className="pt-32 md:pt-48 pb-20">
        <header className="flex flex-col items-center text-center mb-16 px-4 reveal">
          <div className="inline-block px-5 py-2 bg-blue-50/50 dark:bg-blue-900/20 backdrop-blur-md border border-blue-100 dark:border-blue-800 rounded-full mb-8">
             <span className="text-blue-600 dark:text-blue-400 font-black text-[10px] tracking-[0.2em] uppercase">The Rainfall of Revenue Has Begun</span>
          </div>
          <div className="convex-title mb-8 flex justify-center w-full">
            <h1 className="text-5xl md:text-9xl font-black text-slate-900 dark:text-white tracking-tighter leading-[0.9] text-center">Let Success <br /><span className="bg-gradient-to-r from-blue-700 to-indigo-500 bg-clip-text text-transparent italic">Rain Down.</span></h1>
          </div>
          <p className="text-xl md:text-2xl text-slate-400 dark:text-slate-500 max-w-3xl mx-auto font-medium leading-relaxed">RAIN Ai crafts the exact psychological narrative your brand needs.</p>
        </header>

        <section className="reveal">
          <VisualMockup 
            inputValue={productInfo} 
            setInputValue={setProductInfo} 
            onGenerate={handleLaunchDashboard} 
            isLoading={loading} 
          />
        </section>
        
        {error && (
          <div className="max-w-md mx-auto mb-10 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 rounded-2xl text-center font-bold text-sm">
            {error}
          </div>
        )}

        <WhatWeDo />
        <ProcessSteps />
        <Pricing />
      </main>
    </div>
  );
};

export default App;